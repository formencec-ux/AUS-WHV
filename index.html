<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>澳洲打工度假資產管理</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="container">
        <div id="user-logged-out" class="card" style="text-align: center;">
            <h2>歡迎使用</h2>
            <p>請登入以同步您的雲端資料</p>
            <button id="login-btn" class="btn-primary">Google 登入同步雲端</button>
        </div>

        <div id="user-logged-in" style="display: none;">
            <div class="user-profile card">
                <div>
                    <span id="user-display-name" style="font-weight: bold; font-size: 1.2rem;">載入中...</span>
                    <span id="user-region-tag" class="tag">澳洲</span>
                </div>
                <button onclick="window.logout()" class="btn-outline">登出</button>
            </div>

            <div class="card balance-card">
                <div class="balance-label">目前總資產 (AUD)</div>
                <div id="total-balance" class="balance-amount">$0.00</div>
            </div>

            <div class="grid-2">
                <div class="card">
                    <label>今日匯率 (AUD/TWD)</label>
                    <input type="number" id="rate-input" value="21.0" step="0.1">
                </div>
                <div class="card">
                    <label>換算台幣 (TWD)</label>
                    <div id="twd-balance" style="font-size: 1.2rem; font-weight: bold; color: #2ecc71; margin-top: 10px;">$0</div>
                </div>
            </div>

            <div class="card">
                <h3>新增收支</h3>
                <div class="form-group">
                    <input type="text" id="desc-input" placeholder="項目說明 (如：薪水、買菜)">
                </div>
                <div class="form-group">
                    <input type="number" id="amount-input" placeholder="金額 (正數為收，負數為支)">
                </div>
                <button id="add-btn" class="btn-primary" style="width: 100%;">儲存紀錄</button>
            </div>

            <div class="card">
                <h3>歷史紀錄</h3>
                <ul id="history-list" class="history-list">
                    </ul>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // 你的 Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyDtrz_n4ec9HXFIgy45kepTG4Tot4Uuni4",
            authDomain: "for-working-holiday.firebaseapp.com",
            projectId: "for-working-holiday",
            storageBucket: "for-working-holiday.firebasestorage.app",
            messagingSenderId: "253275303946",
            appId: "1:253275303946:web:d49779ba965eb276b3aff3"
        };

        // 初始化
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        // 強制開啟帳號選擇器，這能解決大部分閃退問題
        provider.setCustomParameters({ prompt: 'select_account' });

        // 暴露給 window 的全域函數
        window.auth = auth;
        window.db = db;
        window.logout = () => signOut(auth);

        // 監聽登入狀態
        onAuthStateChanged(auth, async (user) => {
            const loginSect = document.getElementById('user-logged-out');
            const userSect = document.getElementById('user-logged-in');
            
            if (user) {
                loginSect.style.display = 'none';
                userSect.style.display = 'block';
                
                const userRef = doc(db, "users", user.uid);
                
                // 即時同步雲端資料
                onSnapshot(userRef, (snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.data();
                        document.getElementById('user-display-name').innerText = data.nickname || user.displayName;
                        // 這裡可以呼叫 script.js 的 UI 更新函數
                        if (window.updateUIFromData) window.updateUIFromData(data.state);
                    } else {
                        // 第一次登入，建立初始檔案
                        const nickname = prompt("請輸入您的暱稱：") || user.displayName;
                        setDoc(userRef, {
                            nickname: nickname,
                            email: user.email,
                            state: { balance: 0, history: [] },
                            createdAt: new Date()
                        });
                    }
                });
            } else {
                loginSect.style.display = 'block';
                userSect.style.display = 'none';
            }
        });

        // 登入按鈕點擊事件
        document.getElementById('login-btn').onclick = () => {
            signInWithPopup(auth, provider)
                .then(() => console.log("登入成功"))
                .catch((error) => {
                    console.error("錯誤詳情:", error);
                    // 這裡會抓出具體的報錯原因
                    if (error.code === 'auth/unauthorized-domain') {
                        alert("錯誤：目前的網址未在 Firebase 授權清單中。請至 Firebase 設定 Authorized domains。");
                    } else {
                        alert("登入失敗！\n代碼：" + error.code + "\n訊息：" + error.message);
                    }
                });
        };
    </script>

    <script src="script.js"></script>
</body>
</html>
