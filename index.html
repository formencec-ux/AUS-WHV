<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>澳洲打工度假資產管理</title>
    <link href="style.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  </head>
  <body>
    <div class="app-container">
      <header><h1>🦘 澳洲打工度假管理</h1></header>

      <section id="auth-section" class="card shadow" style="text-align: center;">
        <div id="user-logged-out">
          <button id="login-btn" class="btn-primary" style="background: #4285F4; margin: 0; padding: 10px;">
            <i class="fab fa-google"></i> Google 登入同步雲端
          </button>
        </div>
        <div id="user-logged-in" style="display: none; font-size: 0.8rem;">
          <span id="user-display-name"></span> (<span id="user-region-tag"></span>)
          <button onclick="logout()" style="background:none; border:none; color:#aaa; cursor:pointer; text-decoration:underline; margin-left:10px;">登出</button>
        </div>
      </section>

      <main id="main-content">
        <section class="card shadow primary-card">
          <h2><i class="fas fa-coins"></i> 總資產估算 (現金 + 股票)</h2>
          <div class="asset-evaluation">
            <div class="eval-grid">
              <div class="eval-item"><small>換算 AUD</small><div id="eval-aud" class="main-value">$ 0.00</div></div>
              <div class="eval-item"><small>換算 TWD</small><div id="eval-twd" class="main-value">$ 0</div></div>
              <div class="eval-item"><small>換算 USD</small><div id="eval-usd" class="main-value">$ 0.00</div></div>
            </div>
          </div>
          <div class="exchange-rate-info" id="exchange-info"></div>
          <div class="currency-details">
            <div class="detail-title">可運用資產</div>
            <div class="currency-list">
              <div class="currency-row"><span class="label">AUD</span><span class="value" id="total-aud">$ 0.00</span></div>
              <div class="currency-row"><span class="label">TWD</span><span class="value" id="total-twd">$ 0</span></div>
              <div class="currency-row"><span class="label">USD</span><span class="value" id="total-usd">$ 0.00</span></div>
            </div>
          </div>
        </section>

        <section class="card shadow investment-summary">
          <div class="card-header-flex">
            <h2><i class="fas fa-chart-line"></i> 投資持倉摘要</h2>
            <button class="mini-btn" onclick="toggleStockModal()">詳細資料</button>
          </div>
          <div class="invest-grid">
            <div class="invest-box"><small>澳股投入</small><span id="invest-aud">0.00</span></div>
            <div class="invest-box"><small>台股投入</small><span id="invest-twd">0</span></div>
            <div class="invest-box"><small>美股投入</small><span id="invest-usd">0.00</span></div>
          </div>
        </section>

        <section class="card shadow">
          <h2><i class="fas fa-calendar-check"></i> 簽證天數進度</h2>
          <div class="progress-container">
            <div class="progress-row">
              <div class="progress-info"><span>二簽 (88天)</span><b id="days-2nd-text">0 / 88</b></div>
              <div class="progress-bar"><div class="progress-fill" id="progress-2nd"></div></div>
            </div>
            <div class="progress-row">
              <div class="progress-info"><span>三簽 (179天)</span><b id="days-3rd-text">0 / 179</b></div>
              <div class="progress-bar"><div class="progress-fill" id="progress-3rd"></div></div>
            </div>
          </div>
          <div class="work-action-group">
            <button class="work-btn-large" onclick="addWorkDay()">不想上班但沒錢...</button>
            <div class="work-btn-sub">
              <button onclick="undoWorkDay()">按錯ㄌ</button>
              <button onclick="showWorkLogs()">紀錄</button>
              <button onclick="exportCSV()" class="btn-csv"><i class="fas fa-file-csv"></i></button>
            </div>
          </div>
        </section>

        <section class="card shadow">
          <h2><i class="fas fa-exchange-alt"></i> 資產幣值轉換</h2>
          <div class="exchange-form">
            <div class="exchange-input-row">
              <select id="ex-from" class="styled-select" onchange="updatePreview()"><option value="AUD">AUD</option><option value="TWD">TWD</option><option value="USD">USD</option></select>
              <i class="fas fa-chevron-right"></i>
              <select id="ex-to" class="styled-select" onchange="updatePreview()"><option value="TWD">TWD</option><option value="AUD">AUD</option><option value="USD">USD</option></select>
            </div>
            <div class="exchange-input-row mt-10" style="align-items: stretch;">
              <input type="number" id="ex-amount" placeholder="換出金額" oninput="updatePreview()" style="margin-bottom: 0; flex: 2;">
              <button class="btn-primary-small no-wrap" onclick="executeExchange()" style="margin-top: 0; flex: 1;">換匯</button>
            </div>
            <div id="ex-preview" style="font-size: 0.75rem; color: #666; margin-top: 8px; min-height: 1.2em;"></div>
          </div>
        </section>

        <section class="card shadow">
          <h2><i class="fas fa-plus-circle"></i> 新增股票投資</h2>
          <div class="input-form">
            <div class="type-switcher" id="stock-currency-container">
              <button class="type-btn active" data-curr="AUD" onclick="setStockCurr('AUD')">澳股AUD</button>
              <button class="type-btn" data-curr="TWD" onclick="setStockCurr('TWD')">台股TWD</button>
              <button class="type-btn" data-curr="USD" onclick="setStockCurr('USD')">美股USD</button>
            </div>
            <input type="hidden" id="stock-curr" value="AUD" />
            <div class="input-flex mt-10">
              <input type="text" id="stock-name" placeholder="標的名稱" style="flex: 2;">
              <input type="number" id="stock-shares" placeholder="股數" style="flex: 1;">
            </div>
            <input type="number" id="stock-cost" placeholder="投入總金額 (含手續費)">
            <button class="btn-primary" onclick="addInvestment()" style="background-color: #2c3e50;">記錄投資</button>
          </div>
        </section>

        <section class="card shadow">
          <h2><i class="fas fa-edit"></i> 新增收支紀錄</h2>
          <div class="input-form">
            <div class="type-switcher" id="type-container">
              <button class="type-btn" data-type="expense" onclick="setType('expense')">支出</button>
              <button class="type-btn active" data-type="income" onclick="setType('income')">收入</button>
            </div>
            <input type="hidden" id="trans-type" value="income" />
            <div class="input-flex mt-10">
              <input type="text" id="trans-desc" placeholder="項目" style="flex: 2;">
              <input type="number" id="trans-amount" placeholder="金額" style="flex: 1;">
            </div>
            <div class="type-switcher" id="currency-container">
              <button class="type-btn active" data-currency="AUD" onclick="setCurrency('AUD')">AUD</button>
              <button class="type-btn" data-currency="TWD" onclick="setCurrency('TWD')">TWD</button>
              <button class="type-btn" data-currency="USD" onclick="setCurrency('USD')">USD</button>
            </div>
            <input type="hidden" id="trans-currency" value="AUD" />
            <button class="btn-primary" onclick="addTransaction()">確認送出</button>
          </div>
          <button class="btn-reset" onclick="resetAssets()">重置所有資料</button>
        </section>

        <section class="card shadow">
          <h2><i class="fas fa-history"></i> 最近紀錄</h2>
          <ul id="transaction-list" class="list-unstyled"></ul>
        </section>
      </main>

      <div id="stock-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3>持倉細節</h3>
            <span class="close" onclick="toggleStockModal()">&times;</span>
          </div>
          <div id="stock-detail-list"></div>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
      import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
      import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDtrz_n4ec9HXFIgy45kepTG4Tot4Uuni4",
        authDomain: "for-working-holiday.firebaseapp.com",
        projectId: "for-working-holiday",
        storageBucket: "for-working-holiday.firebasestorage.app",
        messagingSenderId: "253275303946",
        appId: "1:253275303946:web:d49779ba965eb276b3aff3",
        measurementId: "G-L99659CCPK"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const provider = new GoogleAuthProvider();

      window.auth = auth;
      window.db = db;
      window.logout = () => signOut(auth);

      onAuthStateChanged(auth, async (user) => {
        const loginSect = document.getElementById('user-logged-out');
        const userSect = document.getElementById('user-logged-in');
        if (user) {
          loginSect.style.display = 'none';
          userSect.style.display = 'block';
          
          const userRef = doc(db, "users", user.uid);
          const snap = await getDoc(userRef);
          if (!snap.exists()) {
            const nickname = prompt("請輸入暱稱：") || user.displayName;
            const region = prompt("請輸入所在澳洲地區：") || "澳洲";
            await setDoc(userRef, { nickname, region, state: window.state });
          }
          const data = (await getDoc(userRef)).data();
          document.getElementById('user-display-name').innerText = data.nickname;
          document.getElementById('user-region-tag').innerText = data.region;

          onSnapshot(userRef, (d) => { if(d.exists()) { window.state = d.data().state; window.updateUI(); }});
        } else {
          loginSect.style.display = 'block';
          userSect.style.display = 'none';
        }
      });
      document.getElementById('login-btn').onclick = () => signInWithPopup(auth, provider);
    </script>
    <script src="script.js"></script>
  </body>
</html>
